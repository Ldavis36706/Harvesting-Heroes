<!DOCTYPE html>
<html>
<head>
    <title>Harvesting Heroes</title>
    <link rel="icon" href="bountifulharvest.jpeg">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-auth-js@1.3.3/dist/amazon-cognito-auth.min.js"></script>
    <style>
        /* [lightbox styles unchanged, omitted for brevity] */
    </style>
</head>
<body>
    <!-- [HEADER and NAV unchanged, omitted for brevity] -->

    <!-- Grow Goal and Harvest Tracker -->
    <div class="sidebar">
        <div class="location" id="grow-goal-link">
            <h2>Grow Goal</h2>
            <p>Our goal is to grow 500 lbs of food this season!</p>

            <div class="tracker-container">
                <h2>Harvest Tracker</h2>
                <p id="trackerMessage">Loading...</p>
                <div style="width: 300px; height: 300px; display: flex; justify-content: center; align-items: center;">
                    <canvas id="harvestTracker"></canvas>
                </div>
            </div> 

            <button onclick="login()">Sign In</button>
            <button onclick="logout()">Sign Out</button>

            <h2>Enter Harvest Data</h2>
            <form id="harvestForm">
                <!-- [Inputs unchanged] -->
                <button type="button" onclick="addHarvest()">Add to List</button>
                <button type="button" id="submitBtn" onclick="submitAll()" disabled>Submit to Database</button>
            </form>
            <h3>Harvest List</h3>
            <ul id="harvestList"></ul>
        </div>
    </div>

    <!-- Lightbox and script -->
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img">
    </div>

    <script>
        // [plant list, chart logic, lightbox functions unchanged ‚Äî omitted for brevity]

        let harvestEntries = [];
        const totalExpectedWeight = 500;

        // [Chart setup, fetch logic unchanged ‚Äî omitted for brevity]

        function submitAll() {
            if (harvestEntries.length === 0) {
                alert("No entries to submit.");
                return;
            }

            fetch('https://1ysvae9t7h.execute-api.us-east-1.amazonaws.com/prod/harvestEntryHandler', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ harvests: harvestEntries })
            })
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.json();
            })
            .then(data => {
                const messages = [
                    "üåª Way to grow!", "üéâ Harvest logged successfully!",
                    "üåø Keep up the great work!", "üçÖ Another step toward our goal!",
                    "ü•ï You're doing amazing things!", "üåª Keep growing!",
                    "üéâ Great job, let's plant some more!", "üåø Enjoy the fruits of your labor!",
                    "üçÖ I'm so proud of you!", "ü•ï You're unstoppable!",
                    "üåª What a harvest!", "üéâ Wohoo, that's what I'm talking about!",
                    "üåø Bro that's an incredible harvest!", "üçÖ Getting closer to hitting that goal, don't stop!",
                    "ü•ï You inspire me, keep going!"
                ];
                const message = messages[Math.floor(Math.random() * messages.length)];
                const trackerMessage = document.getElementById("trackerMessage");
                trackerMessage.textContent = message;
                trackerMessage.style.color = "green";

                setTimeout(() => {
                    trackerMessage.textContent = `Total Harvested: ${harvestChart.data.datasets[0].data[0]} lbs`;
                    trackerMessage.style.color = "";
                }, 15000);

                harvestEntries = [];
                updateHarvestList();
                fetchTotalHarvestWeight();
            })
            .catch(error => {
                console.error("‚ùå Error submitting harvests:", error);
                document.getElementById("trackerMessage").textContent = "‚ùå Error: Unable to submit your harvest. Please try again.";
            });
        }

        // Cognito Auth Setup
        const authData = {
            ClientId: '2l39pn13rfbasb0ht89i2fhpvq',
            AppWebDomain: 'us-east-1yc2rfcpje.auth.us-east-1.amazoncognito.com',
            TokenScopesArray: ['email', 'openid'],
            RedirectUriSignIn: 'https://d84l1y8p4kdic.cloudfront.net',
            RedirectUriSignOut: 'https://d84l1y8p4kdic.cloudfront.net',
            UserPoolId: 'us-east-1_yC2rfcpje'
        };

        const auth = new CognitoAuth(authData); // Note: no "AmazonCognitoIdentity." prefix
        auth.userhandler = {
            onSuccess: function (result) {
                console.log("Login successful", result);
                alert("Welcome! You're signed in.");
                document.getElementById("submitBtn").disabled = false;
            },
            onFailure: function (err) {
                console.error("Login failed", err);
                alert("Sign-in failed. Please try again.");
                document.getElementById("submitBtn").disabled = true;
            }
        };

        window.onload = function () {
            auth.parseCognitoWebResponse(window.location.href);
        };

        function login() {
            auth.getSession();
        }

        function logout() {
            auth.signOut();
            document.getElementById("submitBtn").disabled = true;
        }

        // Fetch initial weight on load
        fetchTotalHarvestWeight();
    </script>
</body>
</html>
